<html>

    <head>
        <title>Visualization</title>

        <script type="text/javascript" src="protovis-3.2/protovis-d3.2.js"></script>
        <script type="text/javascript" src="data.js"></script>

        <style type="text/css">
            #fig {
                width: 800px;
                height: 600px;
            }
        </style>
    </head>

    <body>

        <div id="fig" style="align:center">
        <div style="text-align:right;padding-right:20;">
            <strong>Population:</strong>
            <select name="population" size="1">
                <option>Total</option>
                <option>Urban</option>
                <option>Rural</option>
            </select>
            <strong>Attribute:</strong>
            <select name="attribute" size="1">
                <option>Water improved(totals)</option>
                <option>Sanitation Unimproved(totals)</option>
            </select>
        </div>

            <script type="text/javascript+protovis">
                var width = 800;
                var height = 480;

                continents = pv.flatten(continents)
                    .key("continent")
                    .key("data", function(d) d)
                    .key("year", function(i) years[i])
                    .key("total")
                    .array();

                continents = continents.filter(function(d) d.data == "water_total_improved_total")

                var sumByYear = pv.nest(continents)
                    .key(function(d) d.year)
                    .rollup(function(v) pv.sum(v, function(d) d.total));
                var sumByContinent = pv.nest(continents)
                    .key(function(d) d.data + d.continent)
                    .rollup(function(v) pv.sum(v, function(d) d.total));

                continents.forEach(function(d) d.percent = 100 * d.total / sumByYear[d.year]);
//debugger;
                var x = new pv.Scale.linear(years).range(0, width);
                var y = new pv.Scale.linear(0, 100).range(0, height);
                var color = pv.Scale.ordinal(1, 2).range("#33f", "#f33");
                var alpha = pv.Scale.linear(pv.values(sumByContinent)).range(.4, .8);

                var vis = new pv.Panel()
                    .width(width)
                    .height(height)
                    .top(9.5)
                    .left(39.5)
                    .right(20)
                    .bottom(30);

                vis.add(pv.Layout.Stack)
                    .layers(pv.nest(continents)
                        .key(function(d) d.continent)
                        .sortKeys(function(a, b) pv.reverseOrder(a.substring(1), b.substring(1)))
                        .entries())
                    .values(function(d) d.values)
                    .x(function(d) x(d.year))
                    .y(function(d) y(d.percent))
                    .layer.add(pv.Area)
               //         .def("alpha", function(d) alpha(sumByContinent[d.key]))
                 //       .fillStyle(function(d) color(d.data).alpha(this.alpha()));

                vis.add(pv.Rule)
                    .data(years)
                    .left(x)
                    .bottom(5)
                    .height(5)
                    .anchor("bottom").add(pv.Label);

                vis.render();
            </script>
        </div>
    </body>

</html>
