<html>

    <head>
        <title>Visualization</title>

        <script type="text/javascript" src="protovis-3.2/protovis-d3.2.js"></script>
        <script type="text/javascript" src="data.js"></script>

        <style type="text/css">
            #fig {
                width: 800px;
                height: 600px;
            }
        </style>
    </head>

    <body>
        <div id="fig" style="align:center">
            <div style="text-align:right;padding-right:20;">
                    <strong>Population:</strong>
                    <select name="population" size="1"
                            onchange="area = this.options[this.selectedIndex].value; update(this);">
                        <option value="total">Total</option>
                        <option value="urban">Urban</option>
                        <option value="rural">Rural</option>
                    </select>
                    <strong>Attribute:</strong>
                    <select name="attribute" size="1"
                            onchange="attribute = this.options[this.selectedIndex].value; update(this);">
                        <option value="water">Water improved(totals)</option>
                        <option value="sanitation">Sanitation Unimproved(totals)</option>
                    </select>
            </div>

            <script type="text/javascript+protovis">
                var area = "total";
                var attribute = "water";

                var width = 800;
                var height = 480;

                continents = pv.flatten(continents)
                    .key("continent")
                    .key("data", function(d) { return d; })
                    .key("year", function(i) { return years[i] })
                    .key("total")
                    .array();

                function data_filter() {
                    if(attribute == "sanitation")
                    {
                        if(area=="urban")
                            return "sanitation_urban_unimproved_total";
                        if(area=="rural")
                            return "sanitation_rural_unimproved_total";
                        else
                            return "sanitation_total_unimproved_total";
                    }
                    else
                    {
                        if(area=="urban")
                            return "water_urban_improved_total";
                        if(area=="rural")
                            return "water_rural_improved_total";
                        else
                            return "water_total_improved_total";
                    }
                }

                function test_data(d) {
                    return d.data == data_filter();
                }

                function test_scale(d) {
                    if(attribute == "sanitation")
                        return "sanitation_total_unimproved_total";
                    else
                        return "water_total_improved_total";
                }

                var x = new pv.Scale.linear(years).range(0, width);
                var y = new pv.Scale.linear(0, pv.max(continents.filter(test_scale), function(d) { return d.total; }) *
                        2).range(0, height);

                var vis = new pv.Panel()
                    .width(width)
                    .height(height)
                    .top(9.5)
                    .left(70)
                    .right(20)
                    .bottom(30);

                vis.add(pv.Rule)
                    .data(function() { return y.ticks(); })
                    .bottom(y)
                    .strokeStyle("#ccc")
                    .anchor("left").add(pv.Label)
                    .text(function(d) { return y.tickFormat(d); })
                    .visible(function(d) { return d > 0; });

                var cur_cont = '';

                var area = vis.add(pv.Layout.Stack)
                    .layers(function() {
                        return pv.nest(continents.filter(test_data))
                            .key(function(d) { return d.continent; })
                            .sortKeys(function(a, b) { return pv.reverseOrder(a.substring(1), b.substring(1)); })
                            .entries();
                    })
                    .values(function(d) { return d.values; })
                    .x(function(d) { return x(d.year); })
                    .y(function(d) { return y(d.total); })
                    .layer.add(pv.Area)
                        .def("alpha", "0.5")
                    .event("mouseover", function(d, p) { cur_cont = d.continent; return vis; })
                    .event("mouseout", function(d) { cur_cont = ''; return vis; });

                vis.add(pv.Panel)
                    .extend(area.parent)
                .add(pv.Area)
                    .extend(area)
                    .fillStyle(null)
                .anchor("bottom").add(pv.Label)
                    .textStyle("#ddd")
                    .textBaseline("bottom")
                    .textAlign(function() { return this.index == 0 ? "left" : (this.index == this.scene
                        .length - 1 ? "right" : "center"); })
                    .text(function(d) { return Math.round(d.total); });;

                vis.add(pv.Rule)
                    .data(years)
                    .left(x)
                    .bottom(0)
                    .height(5)
                    .anchor("bottom").add(pv.Label);

                vis.add(pv.Label)
                    .text(function(d) { return cur_cont; })
                    .font("25px sans-serif")
                    .left(0)
                    .top(15);

                vis.render();

                function update(bla) {
                    y.domain(0, pv.max(continents.filter(test_scale), function(d) { return d.total; }) * 2);
                    vis.render();
                }
            </script>
        </div>
    </body>

</html>
