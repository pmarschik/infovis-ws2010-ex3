<html>

    <head>
        <title>Visualization</title>

        <script type="text/javascript" src="protovis-3.2/protovis-d3.2.js"></script>
        <script type="text/javascript" src="data.js"></script>

        <style type="text/css">
            #fig {
                width: 800px;
                height: 600px;
            }
        </style>
    </head>

    <body>

        <div id="fig" style="align:center">
        <div style="text-align:right;padding-right:20;">
			<form>
            <strong>Population:</strong>
            <select name="population" size="1" ONCHANGE="update(area = this.options[this.selectedIndex].value);">
                <option value = "total">Total</option>
                <option value = "urban">Urban</option>
                <option value = "rural">Rural</option>
            </select>
            <strong>Attribute:</strong>
            <select name="attribute" size="1" ONCHANGE="update(attribute = this.options[this.selectedIndex].value);">
                <option value = "water">Water improved(totals)</option>
                <option value = "sanitation">Sanitation Unimproved(totals)</option>
            </select>
			</form>
        </div>

            <script type="text/javascript+protovis">
			/* Interaction state. */
			var area = "total";
			var attribute = "water";



                var width = 800;
                var height = 480;

                continents = pv.flatten(continents)
                    .key("continent")
                    .key("data", function(d) d)
                    .key("year", function(i) years[i])
                    .key("total")
                    .array();

				function attributeSelection() {
				if(attribute == "water")
				{
					if(area=="urban")
						return "water_urban_improved_total";
					if(area=="rural")
						return "water_rural_improved_total";
					else
						return "water_total_improved_total";
				}
				else
				{
					if(area=="urban")
						return "sanitation_urban_unimproved_total";
					if(area=="rural")
						return "sanitation_rural_unimproved_total";
					else
						return "sanitation_total_unimproved_total";
				}
			}


                continents = continents.filter(function(d) d.data == attributeSelection())

                var sumByYear = pv.nest(continents)
                    .key(function(d) d.year)
                    .rollup(function(v) pv.sum(v, function(d) d.total));
                var sumByContinent = pv.nest(continents)
                    .key(function(d) d.data + d.continent)
                    .rollup(function(v) pv.sum(v, function(d) d.total));

                continents.forEach(function(d) d.percent = 100 * d.total / sumByYear[d.year]);

                max = pv.max(continents, function(d) d.total) * 2;
//debugger;
                var x = new pv.Scale.linear(years).range(0, width);
                var y = new pv.Scale.linear(0, max).range(0, height);

                var vis = new pv.Panel()
                    .width(width)
                    .height(height)
                    .top(9.5)
                    .left(70)
                    .right(20)
                    .bottom(30);

                vis.add(pv.Rule)
                    .data(y.ticks())
                    .bottom(y)
                    .strokeStyle(function(y) y ? "#ccc" : "#000")
                    .anchor("left").add(pv.Label)
                    .text(function(d) y.tickFormat(d))
                    .visible(function(d) d > 0);

                var cur_cont = '';

                var area = vis.add(pv.Layout.Stack)
                    .layers(pv.nest(continents)
                        .key(function(d) d.continent)
                        .sortKeys(function(a, b) pv.reverseOrder(a.substring(1), b.substring(1)))
                        .entries())
                    .values(function(d) d.values)
                    .x(function(d) x(d.year))
                    .y(function(d) y(d.total))
                    .layer.add(pv.Area)
                    .event("mouseover", function(d) { cur_cont = d.continent; return vis; })
                    .event("mouseout", function(d) { cur_cont = ''; return vis; })

                vis.add(pv.Rule)
                    .data(years)
                    .left(x)
                    .bottom(0)
                    .height(5)
                    .anchor("bottom").add(pv.Label);

                vis.add(pv.Label)
                    .text(function(d) cur_cont).font("25px sans-serif")
                    .left(0)
                    .top(15);

                vis.render();
            </script>
        </div>
    </body>

</html>
